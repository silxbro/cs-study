# 백업과 복원
<br/>

백업은 사전적으로 지원, 예비품 등을 의미한다. 데이터베이스에서도 역시 예상하지 못한 장애에 대비하여 데이터베이스를 복제하여 보관하는 작업을 백업(backup)이라고 한다.
복원(recovery)은 장애가 발생하여 운영 중인 데이터에 손상이 발생했을 때 기존에 복사해 둔 백업 파일을 사용하여 원래대로 되돌려 놓는 작업을 말한다.

DBA는 데이터베이스 시스템이 문제없이 동작할 수 있도록 관리해야 하고 문제가 발생했을 때 신속하고 적절하게 대응해야 한다.
또한 장애가 일어났을 때 복구를 위해 데이터베이스 백업을 미리 해두어야 한다.
백업 및 복구는 운영 중인 하드웨어 및 네트워크 환경에 따라 예상되는 장애를 고려하여 치밀하게 계획을 수립한 후 신속하게 진행해야 한다.
다음은 데이터베이스 시스템 운영 시 일어날 수 있는 장애들이다.

#### 🔳 미디어 오류
데이터베이스가 저장된 매체(일반적으로 하드디스크)의 고장이나 삭제 등으로 인해 데이터베이스 파일을 사용하지 못하게 되는 오류를 말한다.

#### 🔳 사용자 오류
데이터베이스는 업무의 특성상 여러 부문의 사용자가 접속하여 사용한다.
이 과정에서 사용자가 데이터를 삭제하거나 잘못된 데이터로 업데이트하는 등의 실수를 저질러 데이터가 유실·변경될 수 있는데, 이를 사용자 오류라고 한다.

#### 🔳 하드웨어 장애
데이터베이스 시스템은 일종의 소프트웨어이다. 이러한 소프트웨어는 물리적인 하드웨어(서버)에 의해 운영되는데, 물리적 하드웨어는 자연재해나 정전 등의 이유로 장애가 발생할 수 있다.
이 경우 데이터베이스 역시 사용할 수 없다.

이 절에서는 백업 및 복구 방법에 대해 알아보고 직접 실습해본다.
<br/>
<br/>
## 1. 백업의 종류
백업은 일반적으로 전체 백업, 차등 백업, 증분 백업으로 나눌 수 있다. 각 방법은 데이터베이스뿐만 아니라 파일시스템, 서버 등에서도 사용되는 공통적인 개념이다
(각 DBMS별로 용어가 다르고 때에 따라 불가능할 수도 있다). 각 백업의 개념을 이해하기 위해 다음 그림을 보자.

#### [데이터 파일의 입력 순서(시간순)]
<img src="https://github.com/silxbro/cs-study/assets/142463332/13573fbf-6c81-46fd-8bf6-77c95869e7bd" width="470" height="270"/><br/>

위 그림은 데이터베이스에 데이터를 입력하고 수정하는 과정을 시간순으로 표시한 것이다. 제일 처음에는 10을 입력하고, 5분 후에는 20, 10분 후에는 30을 입력하였다.

#### 🔳 전체 백업
전체 백업은 데이터베이스 개체, 시스템 테이블, 데이터 등 데이터베이스 전체를 백업하는 것이다. 백업 시점의 데이터베이스 복사본을 만들어 두는 것으로 이해하면 된다.
백업을 수행할 때마다 수행 시점의 모든 데이터를 백업하기 때문에 여러 번 하면 각 백업 파일에 데이터가 중복 저장된다.
또한 데이터의 양이 많을 경우 백업을 수행할 때마다 많은 시간이 소요된다. 따라서 최초에 데이터베이스를 생성했을 때나 데이터베이스에 변경이 있을 때 수행하는 것이 좋다.

위 그림의 경우 전체 백업을 하면 최초에 10이 입력된 후 첫 번째 백업 파일에는 10이 저장된다. 20을 입력한 후 두 번째 백업 역시 전체 백업을 수행하므로 10, 20이 저장된다.
첫 번째 백업 파일과 두 번째 백업 파일은 모두 10이라는 중복 값을 가지고 있다.

#### 🔳 차등 백업
차등 백업은 전체 백업을 수행한 이후 변경된 데이터만 저장한다. 전체 백업으로 데이터베이스의 복사본을 만든 후 그 복사본과 차이가 있는 변경 부분만 백업하는 방법이다.

위 그림에서 첫 번째 작업 시점에 전체 백업이 이루어지고, 두 번째와 세 번째 작업 시점에 차등 백업이 이루어지면 첫 번째 백업 파일에는 10이 저장되고, 두 번째 백업 파일에는
20이 저장되며, 세 번째 백업 파일에는 20과 30이 저장된다.
복원 시에는 첫 번째 백업 파일과 마지막 백업 파일을 사용하는데, 첫 번째 백업 파일로 10을 복구한 후 세 번째 백업 파일로 20과 30을 복구한다.
두 번째 백업 파일은 전체 복구를 수행할 경우 필요가 없다.

#### 🔳 증분 백업
데이터베이스에서 수행한 작업을 기록하고 있는 트랜잭션 로그 파일을 저장하는 방법이다. 로그 파일은 데이터의 입력, 수정, 삭제에 관련된 질의를 순서대로 기록하고 있다.
백업은 최초에 전체 백업을 수행한 후 로그 백업을 수행한다. 로그 백업은 로그만 저장하므로 빠르게 수행할 수 있으나 복구 시 많은 시간이 소요된다.
따라서 대량의 데이터 작업이 발생한 경우에는 가급적 사용하지 않는 것이 좋다.

위 그림에서 첫 번째 작업 시점에 전체 백업이 이루어지고, 두 번째와 세 번째 작업 시점에 트랜잭션 로그 백업이 이루어지면 첫 번째 백업 파일에는 10이 저장되고, 두 번째에는
<insert 20>이라는 로그 기록이 저장되고 로그 기록을 비운다. 이후 세 번째 작업도 마찬가지로 <insert 30>이라는 로그 기록이 저장되고 로그 기록은 비운다.
복원 시에는 최초에 전체 백업한 파일과 두 번째, 세 번째 트랜잭션 로그가 모두 필요하다.
<br/>
<br/>
## 2. 데이터베이스 백업 방법
MySQL의 경우 백업 방법을 물리적 백업(Physical Backup)과 논리적 백업(Logical Backup)으로 나눌 수 있다.
각 방법별로 운영하는 환경에 맞게 전체 백업, 차등 백업, 증분 백업 등의 방법을 적용하여 진행할 수 있다.

### 물리적 백업
물리적 백업(Physical Backup)은 데이터베이스를 구동하기 위해 필요한 모든 파일을 물리적으로 '복사'하는 방법이다.
본 백업은 실제 운영체제상의 복사 명령을 통해 수행하거나 백업 소프트웨어를 활용하여 수행한다.
물리적 백업은 실제 DBMS의 운영 파일 및 데이터 파일을 복사하여 보관하는 방식이므로 DBMS의 버전이나 운영 중인 운영체제의 버전이 달라지면 복구할 수 없을 수도 있다.

물리적 백업은 데이터베이스가 운영 중일 때 진행하느냐 중지했을 때 진행하느냐에 따라 콜드 백업(Cold Backup, offline backup)과 핫 백업(Hot Backup, online backup)으로 나눌 수 있다.

#### 🔳 콜드 백업
콜드 백업(Cold Backup)은 데이터베이스를 셧다운(shutdown)한 후에 백업을 진행하는 방법이다. 닫힌 백업 또는 오프라인 백업(Offline Backup)이라고도 부른다.
데이터베이스가 셧다운되면 이후 어떠한 변화도 없으므로 그때 필요한 모든 파일을 다른 저장 장소에 복사한다.
이 방법은 데이터베이스를 백업하기 위해 시스템을 중지해야 하므로 24시간 365일 운영하는 시스템에는 적합하지 않다.
콜드 백업은 전체 백업만 가능한데, 백업 툴을 이용하면 차등 백업 형태로도 사용할 수 있다.

#### 🔳 핫 백업
핫 백업(Hot Backup)은 운영 중인 데이터베이스의 파일을 복사하는 방법이다. 열린 백업(Open Backup), 온라인 백업(Online Backup)이라고도 부른다.
DB를 중단하지 않고 백업을 수행하므로 사용량이 많은 시간대에는 백업을 수행하지 않는 것이 좋다. MySQL의 핫 백업은 XtraBackup 등의 별도 툴을 사용하여 수행할 수 있다.

### 논리적 백업
논리적 백업(Logical Backup)은 실제 데이터베이스를 구성하는 물리적 파일을 직접 복사하는 방법이 아니라 데이터베이스가 가지고 있는 콘텐츠(내용)를 별도의 파일로 옮겨
백업하는 방법이다. 이 방법은 MySQL에서 제공하는 유틸리티인 mysqldump를 통해 수행한다.
전체 데이터베이스를 대상으로 진행하거나, 단위 사용자와 테이블별로 진행하거나, 테이블 단위로 진행할 수 있다. 논리적 백업은 데이터를 일종의 스크립터 형태로 백업한다.
따라서 DBMS의 버전 및 운영체제가 달라도 백업된 자료를 기준으로 좀 더 유연하게 복구할 수 있다.
백업 도중에 데이터가 변경될 경우 백업 시작 시점과 종료 시점의 데이터 불일치 문제가 발생할 수 있으므로 주의해야 한다.
<br/>
<br/>
## 3. MySQL 백업 및 복원 실습
지금까지 일반적인 백업의 개념과 백업 방법을 살펴보았다. 여기에서는 MySQL이 제공하는 여러 방법 중 논리적 백업에 해당하는 방법으로 실습해본다.
실습은 MySQL Workbench에서 클릭을 통한 GUI 방식으로 진행한다.

### 백업
우선 MySQL에서 백업 및 복구에 사용할 디렉토리를 지정한 후 다음과 같이 진행한다.
- ❶ 백업 파일이 저장될 폴더를 준비한다. 여기에서는 C:\madang\backup 폴더를 만든다.
- ❷ Workbench에서 root 계정으로 쿼리 창을 만든다. 여기서는 madang 데이터베이스 전체를 백업하고 복원해보도록 한다.

  먼저 데이터베이스가 있는지 확인해본다.
  ```SQL
    USE madang;
    SELECT * FROM Customer;
  ```
  Workbench에서 [Navigator] → Administration 탭 → [MANAGEMENT] → [Data Export]를 클릭한다.

  다음과 같은 Data Export 화면이 뜬다. 화면에서 다음 사항을 선택한다.
  #### [데이터베이스 백업 - Export 화면]
  <img src="https://github.com/silxbro/cs-study/assets/142463332/24d5070b-c65f-4bd0-a008-30f6ebd9ba56" width="700" height="450"/><br/>
    - ① Export할 데이터베이스를 선택한다. 여기에서는 madang을 체크한다.
    - ② Objects to Export에서 모든 사항을 체크한다.
    - ③ Export to Self-Contained File을 선택한다.
    - ④ 백업할 파일을 정한다. 여기에서는 C:\madang\backup\madang.backup.sql로 한다.
    - ⑤ <Start Export>를 클릭한다.

- ❸ 백업이 끝나면 백업 화면을 닫고 백업된 파일을 살펴본다. 여기에서는 C:\madang\backup\madang_backup.sql 파일을 확인한다.

### 복원
복원은 백업할 시점에 저장된 데이터를 모두 다시 회복시키는 과정이다.

- ❶ 복원할 파일을 확인한다. 복원은 백업을 했던 C:\madang\backup\madang_backup.sql을 사용한다.
- ❷ 복원을 실험하려면 madang 데이터베이스에서 테이블을 1개 삭제해본다(root 계정).
  ```SQL
    USE madang;
    SET SQL_SAFE_UPDATES=0;
    DELETE FROM Orders;
    SELECT * FROM Orders;
  ```
  <img src="https://github.com/silxbro/cs-study/assets/142463332/672fe4fc-bf6f-4909-9a26-d00289bb2a35" width="270" height="35"/><br/>

  Workbench에서 [Navigator] → Adiministration 탭 → [MANAGEMENT] → [Data Import/Restore]를 클릭한다.

  아래 그림과 같은 Data Import 화면이 뜬다. 화면에서 다음 사항을 선택한다.
  #### [데이터베이스 복원 - Import 화면]
  <img src="https://github.com/silxbro/cs-study/assets/142463332/24d5070b-c65f-4bd0-a008-30f6ebd9ba56" width="700" height="450"/><br/>
    - ① Import from Self-Contained File을 선택한다.
    - ② 복원할 파일을 선택한다. C:\madang\backup\madang_backup.sql을 선택한다.
    - ③ Default Target Schema를 클릭하여 예에서 madang을 선택한다.
    - ④ <Start Import>를 클릭한다.

- ❸ 복원이 끝나면 복원된 자료를 확인해본다.
  ```SQL
    USE madang;
    SELECT * FROM Orders;
  ```