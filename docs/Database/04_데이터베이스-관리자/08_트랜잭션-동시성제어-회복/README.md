# 트랜잭션, 동시성 제어, 회복
<br/>

- 트랜잭션의 개념을 이해하고 데이터베이스에서 왜 필요한지 알아본다.
- 트랜잭션 실행 시 동시성 제어가 필요한 이유를 알아보고 락킹을 이용한 동시성 제어 기법에 대해 알아본다.
- 락킹보다 완화된 방법으로 트랜잭션의 동시성을 높이는 트랜잭션 고립 수준에 대해 알아본다.
- 데이터베이스 시스템에 문제가 생길 때의 복구 방법을 알아본다.

일상생활에서 비즈니스는 거래를 중심으로 일어난다. 상품을 주문하고 입금을 하면 배송이 되고, 판매처에서 배송 확인을 마치면 거래가 완료된다.
그런데 만약 거래가 중간에 멈추어 입금을 했는데도 상품이 배송되지 않으면 문제가 된다. 즉, 모든 거래는 배송 확인까지 마치던지 아니면 아예 없던 일이 되어야 한다.
데이터베이스에서도 이러한 거래를 취급한다. 데이터베이스에서 거래는 특별히 트랜잭션(transaction)이라고 한다.
트랜잭션은 데이터를 다루는 작업의 단위로, 거래가 일어나는 동안 데이터가 모두 변경되거나 없던 일이 되어야 한다. DBMS는 트랜잭션이 이러한 규칙을 지킬 수 있도록 지원한다.

이 장에서는 트랜잭션의 개념과 성질에 대해 알아보고, 트랜잭션이 동시에 실행될 때 오류 없이 실행되도록 제어하는 기법을 공부한다.
그리고 데이터베이스 시스템에 문제가 생길 경우 복구하는 방법도 알아본다.

### 01 : 트랜잭션의 상태도
<img src="https://github.com/silxbro/cs-study/assets/142463332/716ed6cf-7337-47f1-be25-5a39ed478ac4" width="580" height="180"/><br/>

### 02 : 트랜잭션의 성질
- 원자성
    - 트랜잭션과 관련된 작업들이 전부 수행되던지 아니면 전부 수행되지 않아야 한다.
- 일관성
    - 트랜잭션을 수행하기 전이나 수행한 후나 데이터베이스는 항상 일관성 있는 상태를 유지해야 한다.
- 고립성
    - 트랜잭션 수행 시 다른 트랜잭션의 연산 작업이 끼어들지 못하도록 보장해야 한다.
- 지속성
    - 성공적으로 수행을 완료한 트랜잭션은 변경한 데이터를 데이터베이스에 영구히 저장해야 한다.

### 03 : 동시성 제어
트랜잭션이 동시에 실행될 때 데이터베이스의 일관성을 해치지 않도록 트랜잭션의 데이터 접근을 제어하는 DBMS의 기능이다.

### 04 : 갱신손실
동시성 제어를 하지 않는 트랜잭션들이 발생시키는 문제로, 한 트랜잭션의 갱신이 다른 트랜잭션에 의하여 분실되는 현상이다.

### 05 : 락
트랜잭션이 데이터를 읽거나 변경할 때 데이터에 표시하는 잠금 장치이다.

#### 🔳 락의 유형
- 공유락 : 읽기를 할 때 사용하는 잠금 장치
- 배타락 : 쓰기를 할 때 사용하는 잠금 장치

### 06 : 2단계 락킹
트랜잭션이 락을 걸고 해제하는 시점을 2단계로 나누어 시행하는 락킹 기법이다. 확장단계와 수축단계가 있다.

### 07 : 데드락
두 개 이상의 트랜잭션이 각각 자신의 데이터에 대하여 락을 획득하고 상대방 데이터에 대하여 락을 요청하여 무한 대기 상태에 빠지는 현상을 말한다.

### 08 : 트랜잭션 동시 실행 문제
- 오손 읽기
    - 다른 트랜잭션이 COMMIT을 하지 않은 데이터를 읽은 후 다른 트랜잭션이 철회하면서 발생하는 현상이다.
- 반복불가능 읽기
    - 트랜잭션 중간에 다른 트랜잭션이 변경한 데이터를 읽으면서 발생하는 현상이다.
- 유령데이터 읽기
    - 트랜잭션 중간에 다른 트랜잭션이 삽입한 데이터를 읽으면서 발생하는 현상이다.

### 09 : 트랜잭션 고립 수준 명령어
트랜잭션의 읽기/쓰기에 대한 고립 수준을 결정하는 명령이다. READ UNCOMMITTED, READ COMMITTED, REPEATABLE READ, SERIALIZABLE이 있다.

### 10 : 로그 파일을 이용한 회복
- 재실행(REDO)
    - 로그 파일에 기록된 로그를 이용하여 트랜잭션이 수행한 결과를 다시 반영하는 연산이다.
- 취소(UNDO)
    - 로그 파일에 기록된 로그를 이용하여 트랜잭션이 수행한 결과를 취소하는 연산이다.

### 11 : 회복을 위한 로그 기록 방법
- 즉시갱신
    - 트랜잭션은 '갱신 데이터 → 로그', '버퍼 → 데이터베이스' 작업이 부분완료 전에 동시에 진행될 수 있으며 REDO, UNDO 연산을 이용하여 복구한다.
- 지연갱신
    - 트랜잭션은 '갱신 데이터 → 로그'가 끝난 후 부분완료를 하고 '버퍼 → 데이터베이스' 작업은 부분완료 후에 진행한다. REDO 연산을 이용하여 복구한다.

### 12. 체크포인트
데이터베이스와 트랜잭션 로그 파일을 동기화한 후, 동기화한 시점을 로그 파일에 기록하는 것을 말한다.