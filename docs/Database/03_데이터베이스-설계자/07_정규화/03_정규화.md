# 정규화
<br/>

이상현상의 원인은 여러 가지가 있는데, 대부분 두 가지 이상의 정보가 한 릴레이션에 저장되어 있기 때문에 발생한다. 따라서 이상현상은 릴레이션을 분해하여 제거한다.
분해된 릴레이션에 이상현상이 남아 있다면 이상현상이 없어질 때까지 분해한다. 이상현상이 발생하는 릴레이션을 분해하여 이상현상을 없애는 과정을 정규화(normalization)라고 한다.

#### [릴레이션의 분해 과정]
<img src="https://github.com/silxbro/cs-study/assets/142463332/9e5b18a8-c7b2-45a6-a8f0-c50251f244b6" width="600" height="500"/><br/>
<br/>
<br/>
## 1. 정규화 과정
이상현상이 있는 릴레이션은 이상현상을 일으키는 함수 종속성의 유형에 따라 등급을 구분할 수 있다. 릴레이션은 정규형이라는 개념으로 구분한다.
정규형이 높을수록 이상현상은 줄어든다.
#### [릴레이션의 등급 구분]
<img src="https://github.com/silxbro/cs-study/assets/142463332/1543ffdc-f022-481d-b21f-74996832ee8c" width="520" height="160"/><br/>

### 제 1정규형
다음은 제 1정규형의 정의이다. 참고로 정의는 정확한 의미를 알 수 있도록 영문을 포함하여 기술하였다. 제 1정규형은 릴레이션의 속성 값이 원자값이어야 한다는 조건이다.
#### [제 1정규형]
**릴레이션 R의 모든 속성 값이 원자값을 가지면 제 1정규형이라고 한다.**<br/>
(A relation in which the intersection of each row and column contains one and only one value.)

#### 🔳 제 1정규형으로 변환
관계 데이터베이스에서 릴레이션의 속성 값은 반드시 원자값이어야 한다. 아래의 고객취미들(이름, 취미) 릴레이션을 보자.
추신수 선수의 취미가 (영화, 음악)이므로 원자값이 아니다. 속성 값이 원자값이 아닐 경우 원자값을 갖도록 변환해주어야 한다.

고객취미들(이름, 취미) 릴레이션을 고객취미(이름, 취미) 릴레이션으로 바꾸어 저장하면 제 1정규형을 만족한다.
- 고객취미들(이름, 취미)<br/>
  → 고객취미(이름, 취미)

#### [속성 값이 원자값을 갖도록 분해]
<img src="https://github.com/silxbro/cs-study/assets/142463332/d19606bd-1cc6-4c12-b3a4-68b24cd8f22e" width="350" height="200"/><br/>

### 제 2정규형
제 2정규형은 릴레이션의 기본키가 복합키일 때, 복합키의 일부분이 다른 속성의 결정자인지 여부를 판단하는 것이다.

#### [제 2정규형]
**릴레이션 R이 제 1정규형이고 기본키가 아닌 속성이 기본키에 완전 함수 종속일 때 제 2정규형이라고 한다.** <br/>
(A relation that is in first normal form and every non-primary key attribute is fully functionally dependent on the primary key.)
- 제 2정규형은 기본키 외에 후보키가 여러 개 있을 경우를 고려하여 일반적으로 다음과 같이 정의한다.
  - 릴레이션 R이 제 1정규형이고, 릴레이션 스키마 R의 모든 비주요 속성(non-primary)이 후보키에 완전 함수 종속일 때 제 2정규형이라고 한다.
    릴레이션의 비주요 속성이란 후보키에 속하지 않는 속성을 말한다.

제 2정규형을 이해하기 위해서는 완전 함수 종속의 개념을 이해해야 한다.
#### [완전 함수 종속]
A와 B가 릴레이션 R의 속성이고 A → B 종속성이 성립할 때, B가 A의 속성 전체에 함수 종속하고 부분 집합 속성에 함수 종속하지 않을 경우
완전 함수 종속(full functional dependency)이라고 한다.

반면, A → B 종속성에서 A의 속성 일부를 제거해도 종속성이 여전히 성립하는 경우 불완전 함수 종속 혹은 부분 함수 종속(partial functional dependency)이라고 한다.
- 예를 들어 (A1, A2) → B 종속성에서 A2를 제거했는데도 A1 → B가 여전히 성립한다면 불완전 함수 종속이다.

아래의 수강강좌(학생번호, 강좌이름, 강의실, 성적) 릴레이션을 보자. 수강강좌 릴레이션은 수강 정보와 강의실 정보를 저장한다.

#### [수강강좌 릴레이션]
<img src="https://github.com/silxbro/cs-study/assets/142463332/078825c7-98f7-419d-898a-b3cda90fe276" width="520" height="140"/><br/>

#### 🔳 이상현상
수강강좌 릴레이션의 기본키는 (학생번호, 강좌이름)이며, 기본키의 일부인 강좌이름 속성이 강의실을 결정하는 '강좌이름 → 강의실' 종속관계를 가지고 있다.

- 삭제이상
  - 402번 학생이 수강을 취소하면 스포츠경영학 과목의 강의실에 대한 정보가 사라진다.
- 삽입이상
  - 컴퓨터입문 과목이 개설되어 공학관 112호를 사용하게 되었는데 아직 신청한 학생이 없다.
    이 경우 수강강좌 릴레이션에 학생번호와 성적을 NULL 값으로 삽입해야 하는 문제가 발생한다.
- 수정이상
  - 데이터베이스 강의실을 공학관 113호로 변경할 경우 데이터 불일치가 발생할 가능성이 있다.

#### 🔳 이상현상의 원인
이상현상의 원인은 수강강좌 릴레이션의 함수 종속성 다이어그램을 보면 알 수 있다. 수강강좌 릴레이션의 기본키는 (학생번호, 강좌이름)이고, 기본키가 아닌 속성은 성적, 강의실이다.
성적과 강의실은 모두 기본키에 함수적으로 종속되어 있지만 강의실은 기본키의 일부인 강좌 이름에 한 번 더 종속되어 있다.
즉 기본키 (학생번호, 강좌이름)의 부분집합인 강좌이름에 종속된다. 이와 같이 기본키가 아닌 속성이 기본키에 완전 함수 종속이 아닌 불완전 함수 종속되어 있으면 이상현상이 발생한다.
(학생번호, 강좌이름) → 강의실 종속성의 경우 학생번호를 제거해도 '강좌이름 → 강의실' 종속성은 여전히 성립한다.

#### 🔳 제 2정규형으로 변환
수강강좌 릴레이션에서 이상현상을 일으키는 (강좌이름, 강의실)을 분해하면 다음과 같다.
- 수강강좌(학생번호, 강좌이름, 강의실, 성적)<br/>
  → 수강(학생번호, 강좌이름, 성적), 강의실(강좌이름, 강의실)

#### [수강강좌 릴레이션을 수강, 강의실 릴레이션으로 분해]
<img src="https://github.com/silxbro/cs-study/assets/142463332/5f5f9a4d-6d13-485b-96c7-ce000e3e9fb5" width="450" height="290"/><br/>

### 제 3정규형
제 3정규형은 속성들이 이행적(transitive)으로 종속되어 있는지 여부를 판단하는 것이다.
#### [제 3정규형]
**릴레이션 R이 제 2정규형이고 기본키가 아닌 속성이 기본키에 비이행적(non-transitive)으로 종속할 때(직접 종속) 제 3정규형이라고 한다.
이행적 종속이란 A → B, B → C가 성립할 때 A → C가 성립되는 함수 종속성을 말한다.** <br/>
(A relation that is in first and second normal form and in which no non-primary key is transitively dependent on the primary key.)
- 제 3정규형은 후보키가 여러 개 있을 경우를 고려하여 일반적으로 다음과 같이 정의한다.
  - 릴레이션 R이 제 2정규형이고, 릴레이션 스키마 R의 모든 비주요 속성(non-primary)이 후보키에 비이행적으로 종속할 때 제 3정규형이라고 한다.
    릴레이션의 비주요 속성이란 후보키에 속하지 않는 속성을 말한다.

아래의 계절학기(학생번호, 강좌이름, 수강료) 릴레이션을 보자. 계절학기 릴레이션은 수강 정보와 수강료 정보를 제공한다.
단, 계절학기이기 때문에 학생은 한 강좌만 신청할 수 있다고 가정한다.

#### [계절학기 릴레이션]
<img src="https://github.com/silxbro/cs-study/assets/142463332/ef762656-b8a6-4d94-99c9-7b0f18cbeb0e" width="520" height="140"/><br/>

#### 🔳 이상현상
이상현상은 릴레이션의 기본키가 아닌 강좌이름이 수강료를 결정하는 종속관계에서 발생한다.

- 삭제이상
  - 402번 학생이 수강을 취소하면 스포츠경영학 과목의 수강료에 대한 정보가 사라진다.
- 삽입이상
  - 컴퓨터입문 과목이 개설되어 수강료 15,000원을 삽입해야 하는데, 아직 신청한 학생이 없어 학생번호를 NULL 값으로 삽입해야 하는 문제가 발생한다.
- 수정이상
  - 데이터베이스 수강료를 15,000원으로 변경할 경우 데이터 불일치가 발생할 가능성이 있다.

#### 🔳 이상현상의 원인
이상현상의 원인은 계절학기 릴레이션의 함수 종속성 다이어그램을 보면 알 수 있다. 계절학기 릴레이션의 기본키는 학생번호이고, 기본키가 아닌 속성은 강좌이름, 수강료이다.
강좌이름, 수강료는 모두 기본키에 함수적으로 종속되어 있다. 그런데 수강료는 기본키가 아닌 강좌이름에 한 번 더 종속되어 있다.
결국 (학생번호 → 강좌이름), (강좌이름 → 수강료)로 수강료는 기본키에 이행적으로 종속되어 있다. 이때 이상현상이 발생한다.
- 강좌이름은 부분 릴레이션(강좌이름, 수강료)의 기본키인 셈이다.

#### 🔳 제 3정규형으로 변환
계절학기 릴레이션에서 이상현상을 일으키는 (강좌이름, 수강료)를 분해하면 다음과 같다.
- 계절학기(학생번호, 강좌이름, 수강료)<br/>
  → 계절수강(학생번호, 강좌이름), 수강료(강좌이름, 수강료)

#### [계절학기 릴레이션을 계절수강, 수강료 릴레이션으로 분해]
<img src="https://github.com/silxbro/cs-study/assets/142463332/97c7c3e8-fb95-4a37-adb1-fbe7315af4bd" width="360" height="280"/><br/>

### BCNF
릴레이션에 존재하는 함수 종속성에서 모든 결정자가 후보키이면 BCNF(Boyce Codd Normal Form) 정규형이다.
- BCNF는 Boyce와 Codd라는 사람의 첫 글자를 따서 붙인 것이고, NF는 Normal Form의 약자이다.

#### [BCNF 정규형]
**릴레이션 R에서 함수 종속성 X → Y가 성립할 때 모든 결정자 X가 후보키이면 BCNF 정규형이라고 한다.** <br/>
(A relation is in BCNF if and  only if every determinant is a candidate key.)

아래의 특강수강(학생번호, 특강이름, 교수) 릴레이션을 보자. 한 학생은 한 개 이상의 특강을 신청할 수 있고, 교수는 한 특강만 담당한다고 가정한다.
#### [특강수강 릴레이션]
<img src="https://github.com/silxbro/cs-study/assets/142463332/b035a7e1-1bef-47db-a34c-cc4d1bf9d6a2" width="480" height="170"/><br/>

#### 🔳 이상현상
이상현상은 릴레이션의 기본키가 아닌 교수가 특강이름을 결정하는 종속관계에서 발생한다.

- 삭제이상
  - 402번 학생이 수강을 취소하면 인간과 동물 특강을 담당하는 교수 정보가 사라진다.
- 삽입이상
  - 최교수가 취업특강을 새로 맡았는데, 아직 신청한 학생이 없어 학생번호를 NULL 값으로 삽입해야 하는 문제가 발생한다.
- 수정이상
  - 김교수의 특강 제목을 소셜네트워크에서 소셜네트워크 분석으로 변경할 경우 데이터 불일치가 발생할 가능성이 있다.

#### 🔳 이상현상의 원인
이상현상의 원인은 특강수강 릴레이션의 함수 종속성 다이어그램을 보면 알 수 있다.
특강수강의 기본키는 (학생번호, 특강이름)이며, (학생번호, 특강이름) → 교수, 교수 → 특강이름 관계가 성립한다.
여기서 교수는 한 개의 특강만 개설하기 때문에 '교수 → 특강이름' 관계가 성립하는 것이다.
특강수강 릴레이션의 결정자 중 (학생번호, 특강이름)은 후보키이지만 교수는 후보키가 아니다. 이와 같이 결정자이면서 후보키가 아닌 속성이 존재하면 이상현상이 발생한다.
- 교수는 부분 릴레이션(교수, 특강이름)의 기본키인 셈이다.

#### 🔳 BCNF 정규형으로 변환
특강수강 릴레이션에서 이상현상을 일으키는 (교수, 특강이름)을 분해하면 다음과 같다.
- 특강수강(학생번호, 특강이름, 교수)<br/>
  → 특강신청(학생번호, 교수), 특강교수(특강이름, 교수)

#### [특강수강 릴레이션을 특강신청, 특강교수 릴레이션으로 분해]
<img src="https://github.com/silxbro/cs-study/assets/142463332/104ae278-6b98-4958-9b84-ef91a72a030b" width="420" height="330"/><br/>
<br/>

## 2. 무손실 분해
지금까지 네 가지 정규형을 살펴보았다. 정규화는 릴레이션을 분해하여 이상현상을 제거하는 과정이다. 릴레이션을 분해할 때는 지켜야 할 규칙이 있다.
분해된 릴레이션 간의 관계(relationship)를 유지하기 위해 분해된 릴레이션에 공통 속성을 한 개 이상 두어야 한다는 것이다.
공통 속성은 분해된 릴레이션을 다시 원래의 릴레이션으로 합성(조인)할 때 사용한다. 그러면 어떤 속성을 공통 속성으로 해야 하는지 다음의 무손실 분해 규칙을 통해 알아보자.

#### [무손실 분해]
릴레이션 R을 릴레이션 R1과 R2로 분해할 때, R1⋈R2=R이면 무손실 분해(lossless-join decomposition)라고 한다.
무손실 분해를 위한 조건은 R1∩R2 → R1이나 R1∩R2 → R2 중 하나를 만족해야 한다.

무손실 분해는 릴레이션 R을 분해하여 두 개의 릴레이션 R1과 R2를 만들었을 때, 다시 조인을 하면 원래의 릴레이션 R이 만들어진다는 의미이다.
무손실 분해의 조건은 분해할 때 공통된 속성(R1∩R2)이 릴레이션 R1의 키이거나 (R1∩R2 → R1) 혹은 릴레이션 R2의 키(R1∩R2 → R2)여야 한다.
공통 속성이 왜 한 쪽 릴레이션의 키가 되어야 하는지는 BCNF 정규형에서 예로 들었던 특강수강 릴레이션을 보면서 이해해보자.

특강수강 릴레이션의 키는 (학생번호, 특강이름)이고, (학생번호, 특강이름) → 교수, 교수 → 특강이름 관계가 성립한다.
특강수강 릴레이션은 모든 결정자가 후보키가 아니므로 이상현상이 발생한다. 따라서 특강신청, 특강교수 릴레이션으로 분해하였다.
참고로 무손실 분해 규칙을 설명하기 위해 두 가지 방법으로 분해하였다. 릴레이션의 밑줄 친 속성은 기본키이다.

#### [특강수강 릴레이션의 분해]
|구분|릴레이션 분해|무손실 분해 여부|
|:---|:---|:---|
|[분해1]|특강수강(<u>학생번호</u>, <u>특강이름</u>, 교수)<br/>→ R1(<u>학생번호</u>, <u>교수</u>), R2(<u>교수</u>, 특강이름)|R1과 R2의 공통 속성은 교수이며, 교수는 R2의 키이다.<br/>→ 무손실 분해 규칙을 만족|
|[분해2]|특강수강(<u>학생번호</u>, <u>특강이름</u>, 교수)<br/>→ R3(<u>학생번호</u>, <u>특강이름</u>), R4(<u>교수</u>, 특강이름)|R3과 R4의 공통 속성은 특강이름이지만, 특강이름은<br/> R3이나 R4이 키가 아니다<br/>→ 무손실 분해 규칙을 만족하지 않음|

[분해1]의 경우 R1, R2를 다시 조인하면 원래 릴레이션이 된다. R1과 R2 릴레이션은 아래와 같다. [분해 2]의 경우, R3, R4 릴레이션은 다음과 같다.
#### [특강수강 릴레이션을 R3, R4 릴레이션으로 분해]
<img src="https://github.com/silxbro/cs-study/assets/142463332/03eba008-620b-42e0-8454-ebcfa7b55baa" width="360" height="170"/><br/>

R3, R4 릴레이션을 다시 조인하면 아래와 같다. 결과를 보면 두 개의 튜플이 추가로 생긴 것을 알 수 있다. 원래 릴레이션에 없던 튜플로, 잘못된 정보를 제공하고 있다.
이렇게 의미 없는 튜플이 생긴 이유는 무손실 분해 조건을 만족하지 못하고 손실(loss) 분해되었기 때문이다.

#### [특강수강 릴레이션과 R3⋈R4 릴레이션의 비교]
<img src="https://github.com/silxbro/cs-study/assets/142463332/1c721044-55cb-4b45-9368-d112caff9917" width="520" height="220"/><br/>

제 2정규형과 제 3정규형에서 예로 들었던 릴레이션으로 무손실 분해인지 판단해보자. 공통속성이 분해된 릴레이션 중 한 쪽의 키가 되는 것을 확인해보면 된다.
<br/>
<br/>
## 3. 정규화 정리
정규형은 아래와 같이 정규화되거나 되지 않은 모든 릴레이션(예를 들어 속성 값이 원자값이 아니어서 릴레이션의 정의를 만족하지 못하는 경우 등을 말하며)부터
제 1정규형, 제 2정규형, 제 3정규형, BCNF, 제 4정규형, 제 5정규형까지 존재한다.
제 4정규형은 다치종속성(multivalued dependency)을 가진 릴레이션에 관한 내용이며, 제 5정규형은 프로젝트-조인 정규형(project-join normal form, PJ/NF)이라고 부르며
조인종속성(join dependency)을 가진 릴레이션에 관한 내용이다. 대부분의 릴레이션은 BCNF까지 정규화하면 실제적인 이상현상은 없어진다. 따라서 보통 BCNF까지 정규화를 진행한다.
이 책에서도 제 4정규형과 제 5정규형은 다루지 않는다.
#### [정규형의 포함 관계]
<img src="https://github.com/silxbro/cs-study/assets/142463332/e3444b2a-7ebf-45e4-a0c1-47b7b837b1a1" width="450" height="230"/><br/>

정규화는 릴레이션의 분해를 통해 이루어지는데, 분해 과정에서 주목할 점이 있다.
즉 어떤 정규형 상태인 릴레이션 R1을 분해하여 만든 R2, R3 릴레이션은 R1 다음 정규형이 아닌 더 높은 정규형이 될 수 있다는 점이다.
예를 들어 이행적 종속성이 있는 릴레이션을 분해하여 두 개의 릴레이션을 만들었을 때 분해된 릴레이션은 제 3정규형이 아닌 BCNF 혹은 제 5정규형이 될 수 있다.

몇 가지 정규화 예제를 통해 지금까지 배운 내용을 이해해보자.

#### [예제 7-3] 릴레이션 R(A,B,C,D)는 다음과 같은 함수 종속성이 성립한다. 아래의 물음에 답하시오.
```
A → B, B → C, C → D
```
- ① 릴레이션 R의 후보키를 찾아보시오.
  - A가 B를 결정하고(A → B) B가 C를 결정하면(B → C) A는 BC를 결정한다(A → BC). 마찬가지로 A → BCD, A → ABCD도 만족한다.
    즉, A는 릴레이션 전체를 결정하므로 후보키이다.
- ② 릴레이션 R은 몇 정규형인가?
  - 이행적 종속성이 있으므로 제 2정규형이다.
- ③ 릴레이션을 다음과 같이 분해했을 때 무손실 분해인가?
  ```
  R1(A, B, C), R2(C, D)
  ```
  - R1과 R2의 공통 속성은 C이다. 그리고 C는 R2의 후보키이므로 무손실 분해이다.

#### [예제 7-4] 릴레이션 R(A,B,C)는 다음과 같은 함수 종속성이 성립한다. 아래의 물음에 답하시오.
```
AB → C, C → A
```
- ① 릴레이션 R의 후보키를 찾아보시오.
  - AB → C이므로 AB → ABC도 만족한다. 따라서 AB는 릴레이션 전체를 결정하는 후보키이다. 같은 방식으로 생각해보면 BC도 릴레이션 전체를 결정하는 후보키가 된다.
- ② 릴레이션 R은 몇 정규형인가?
  - 제 2정규형과 제 3정규형을 만족한다. 그러나 C → A에서 결정자 C는 후보키가 아니므로 BCNF가 아니다. 따라서 제 3정규형이다.
- ③ 릴레이션을 다음과 같이 분해했을 때 무손실 분해인가?
  ```
  R1(A, C), R2(B, C)
  ```
  - R1과 R2의 공통 속성은 C이다. 그리고 C는 R2의 후보키이므로 무손실 분해이다.
    - R1(A, B), R2(C, A)와 같이 분해하면 손실 분해가 된다.

#### [예제 7-5] 릴레이션 R(A,B,C,D)는 다음과 같은 함수 종속성이 성립한다. 아래의 물음에 답하시오.
```
AB → C, C → A, C → D
```
- ① 릴레이션 R의 후보키를 찾아보시오.
  - AB가 C를 결정하고(AB → C), C가 D를 결정하면(C → D) AB는 CD를 결정한다(AB → CD). 즉 AB → ABCD이므로 AB는 릴레이션 전체를 결정하는 후보키이다.
    같은 방식으로 생각해보면 BC도 릴레이션 전체를 결정하는 후보키가 된다.
- ② 릴레이션 R은 몇 정규형인가?
  - 제 2정규형은 만족하지만, AB → C, C → D의 이행적 종속성이 있으므로 제 3정규형을 만족하지 못한다. 따라서 제 2정규형이다.
- ③ 릴레이션을 다음과 같이 분해했을 때 무손실 분해인가?
  ```
  R1(A, B, C), R2(C, D)
  ```
  - R1과 R2의 공통 속성은 C이다. 그리고 C는 R2의 후보키이므로 무손실 분해이다.